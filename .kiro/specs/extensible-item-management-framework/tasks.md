# 实施计划：可扩展物品管理框架

## 概述

本实施计划将现有的被子管理系统重构为一个可扩展的通用物品管理框架。实施分为三个主要阶段：

1. **阶段1：用户管理系统** - 建立认证、授权和模块订阅机制
2. **阶段2：被子管理子系统** - 迁移现有功能到新框架
3. **阶段3：球星卡管理子系统** - 验证框架的可扩展性

## 任务列表

### 阶段 1: 用户管理系统

- [x] 1. 设置项目基础架构
  - 初始化 Next.js 16 项目（App Router）
  - 配置 TypeScript 和 ESLint
  - 安装核心依赖（Drizzle ORM、Auth.js v5、shadcn/ui、Tailwind CSS v4）
  - 设置 Neon PostgreSQL 数据库连接
  - 配置环境变量
  - _需求: 1.1, 1.4_

- [x] 2. 实现数据库架构
  - [x] 2.1 创建 Drizzle Schema 定义
    - 定义 users 表（id, name, email, password, role, activeModules）
    - 定义 items 表（单表继承模式，包含 type, attributes JSONB）
    - 定义 usageLogs 表
    - 定义枚举类型（userRoleEnum, itemStatusEnum, itemTypeEnum）
    - _需求: 2.1, 2.2, 8.1_

  - [ ]\* 2.2 编写数据库架构的属性测试
    - **属性 5: JSONB 元数据往返一致性**
    - **验证需求: 2.5**

  - [x] 2.3 运行数据库迁移
    - 生成迁移文件
    - 执行迁移到 Neon 数据库
    - 验证表结构正确创建
    - _需求: 2.1_

- [x] 3. 实现 Auth.js v5 认证系统
  - [x] 3.1 配置 Auth.js v5
    - 创建 auth.ts 配置文件
    - 实现 Credentials Provider
    - 配置 JWT 和 Session callbacks
    - 设置登录页面路由
    - _需求: 8.1, 8.3_

  - [x] 3.2 创建用户注册功能
    - 实现注册 Server Action
    - 使用 bcrypt 进行密码哈希
    - 使用 Zod 验证输入
    - _需求: 8.1_

  - [ ]\* 3.3 编写认证系统的单元测试
    - 测试密码哈希和验证
    - 测试输入验证
    - 测试错误处理
    - _需求: 8.1_

- [x] 4. 实现 Middleware 和路由保护
  - [x] 4.1 创建认证 Middleware
    - 使用 auth() 包装 middleware
    - 实现公开路径和受保护路径的逻辑
    - 实现仪表盘重定向逻辑（单模块直接跳转，多模块显示选择器）
    - 配置 matcher 排除静态资源
    - _需求: 8.1, 8.3_

  - [ ]\* 4.2 编写 Middleware 的单元测试
    - 测试未认证用户重定向
    - 测试已认证用户访问
    - 测试仪表盘重定向逻辑
    - _需求: 8.1_

- [x] 5. 创建用户界面基础组件
  - [x] 5.1 设置 shadcn/ui 组件库
    - 初始化 shadcn/ui
    - 安装基础组件（Button, Input, Form, Card, Badge, Select）
    - 配置 Tailwind CSS v4
    - _需求: 4.1, 4.4_

  - [x] 5.2 创建登录和注册页面
    - 实现登录表单（使用 Next.js 16 Form 组件）
    - 实现注册表单
    - 添加表单验证和错误显示
    - _需求: 8.1_

  - [x] 5.3 创建仪表盘布局
    - 创建 (dashboard) 布局组件
    - 实现导航栏和侧边栏
    - 实现用户菜单和登出功能
    - _需求: 4.1_

- [x] 6. 实现模块订阅管理
  - [x] 6.1 创建模块选择器页面
    - 显示所有可用模块
    - 实现模块订阅/取消订阅功能
    - 更新用户的 activeModules 字段
    - _需求: 5.1, 8.2_

  - [ ]\* 6.2 编写模块订阅的单元测试
    - 测试订阅功能
    - 测试取消订阅功能
    - 测试权限验证
    - _需求: 8.2_

- [x] 7. 检查点 - 确保用户管理系统正常工作
  - 确保所有测试通过，如有问题请询问用户

### 阶段 2: 核心框架和模块系统

- [x] 8. 创建模块注册表系统
  - [x] 8.1 定义模块接口
    - 创建 modules/types.ts 定义 ModuleDefinition 接口
    - 定义 FormFieldConfig、ColumnConfig、StatsConfig 接口
    - _需求: 1.2, 5.1_

  - [x] 8.2 实现模块注册表
    - 创建 modules/registry.ts
    - 实现 MODULE_REGISTRY 对象（策略模式）
    - 实现 getModule()、getAllModules()、hasModule() 函数
    - _需求: 1.1, 1.2_

  - [ ]\* 8.3 编写模块注册表的属性测试
    - **属性 1: 模块注册和检索一致性**
    - **验证需求: 1.1, 2.3**

  - [ ]\* 8.4 编写模块配置验证的属性测试
    - **属性 2: 模块配置验证**
    - **验证需求: 1.3, 5.4**

- [x] 9. 创建通用 UI 组件库
  - [x] 9.1 实现 ItemCard 组件
    - 创建 modules/core/ui/ItemCard.tsx
    - 根据模块类型动态渲染特定卡片组件
    - _需求: 4.1, 4.2_

  - [x] 9.2 实现 ItemList 组件
    - 创建 modules/core/ui/ItemList.tsx
    - 使用网格布局显示物品卡片
    - 处理空状态
    - _需求: 4.1, 4.2_

  - [x] 9.3 实现 ItemForm 组件
    - 创建 modules/core/ui/ItemForm.tsx
    - 基于模块配置动态生成表单字段
    - 使用 Next.js 16 Form 组件实现渐进增强
    - 使用原生 HTML 表单验证（required, type 等）
    - 在 Server Action 中使用 Zod 验证
    - _需求: 4.2, 5.2_

  - [x] 9.4 实现 StatusBadge 组件
    - 创建 modules/core/ui/StatusBadge.tsx
    - 根据状态显示不同样式的徽章
    - _需求: 4.1_

  - [ ]\* 9.5 编写通用组件的单元测试
    - 测试 ItemCard 渲染
    - 测试 ItemList 渲染和空状态
    - 测试 ItemForm 动态字段生成
    - _需求: 4.1, 4.2_

- [x] 10. 实现 Server Actions（CRUD 操作）
  - [x] 10.1 创建物品 CRUD Server Actions
    - 创建 app/actions/items.ts
    - 实现 createItem() - 创建物品
    - 实现 getItems() - 获取物品列表（支持分页和过滤）
    - 实现 getItemById() - 获取单个物品
    - 实现 updateItem() - 更新物品
    - 实现 deleteItem() - 删除物品
    - 在每个操作中验证认证状态
    - 使用 revalidatePath() 更新缓存
    - _需求: 3.2, 8.3, 8.4_

  - [x] 10.2 实现使用日志 Server Actions
    - 实现 getUsageLogs() - 获取使用日志
    - 在 CRUD 操作中自动记录日志
    - _需求: 6.2, 8.5_

  - [ ]\* 10.3 编写 CRUD 操作的属性测试
    - **属性 6: CRUD 操作完整性**
    - **验证需求: 3.2**

  - [ ]\* 10.4 编写数据往返一致性的属性测试
    - **属性 5: JSONB 元数据往返一致性**
    - **验证需求: 2.5**

- [x] 11. 实现动态路由系统
  - [x] 11.1 创建动态模块路由
    - 创建 app/(dashboard)/[category]/page.tsx - 列表页
    - 创建 app/(dashboard)/[category]/new/page.tsx - 新建页
    - 创建 app/(dashboard)/[category]/[id]/page.tsx - 详情页
    - 创建 app/(dashboard)/[category]/[id]/edit/page.tsx - 编辑页
    - 使用 getModule() 获取模块配置
    - 处理模块不存在的情况
    - _需求: 3.1, 3.3_

  - [ ]\* 11.2 编写路由系统的单元测试
    - 测试有效模块的路由
    - 测试无效模块的错误处理
    - _需求: 3.1_

- [x] 12. 实现共享功能服务
  - [x] 12.1 实现图片上传服务
    - 创建 app/actions/upload.ts
    - 集成 UploadThing 或 Vercel Blob
    - 实现图片上传和删除功能
    - _需求: 6.1_

  - [ ]\* 12.2 编写图片上传的属性测试
    - **属性 14: 图片上传往返一致性**
    - **验证需求: 6.1**

  - [x] 12.3 实现统计分析服务
    - 创建 lib/stats.ts
    - 实现通用的统计计算函数
    - 支持自定义指标
    - _需求: 6.2_

  - [ ]\* 12.4 编写统计计算的属性测试
    - **属性 15: 统计计算正确性**
    - **验证需求: 6.2**

  - [x] 12.5 实现数据导出服务
    - 创建 lib/export.ts
    - 实现 CSV 导出
    - 实现 Excel 导出
    - _需求: 6.3_

  - [ ]\* 12.6 编写数据导出的属性测试
    - **属性 16: 数据导出格式正确性**
    - **验证需求: 6.3**

- [x] 13. 检查点 - 确保核心框架功能正常
  - 确保所有测试通过，如有问题请询问用户

### 阶段 3: 被子管理模块迁移

- [x] 14. 创建被子模块配置
  - [x] 14.1 定义被子模块 Schema
    - 创建 modules/quilts/schema.ts
    - 定义 quiltAttributesSchema（使用 Zod）
    - 定义 QuiltAttributes 和 Quilt 类型
    - _需求: 2.2, 5.2_

  - [x] 14.2 创建被子模块配置
    - 创建 modules/quilts/config.ts
    - 定义 quiltModule 配置对象
    - 配置表单字段（brand, size, material, weight, warmthLevel, season 等）
    - 配置列表列
    - 配置统计指标
    - _需求: 5.1, 5.2_

  - [x] 14.3 注册被子模块
    - 在 modules/registry.ts 中注册 quiltModule
    - _需求: 1.1_

- [x] 15. 创建被子模块 UI 组件
  - [x] 15.1 实现 QuiltCard 组件
    - 创建 modules/quilts/ui/QuiltCard.tsx
    - 显示被子的关键信息（名称、尺寸、保暖等级）
    - 显示状态徽章
    - _需求: 4.1_

  - [x] 15.2 实现 QuiltDetail 组件
    - 创建 modules/quilts/ui/QuiltDetail.tsx
    - 显示被子的完整信息
    - 显示图片轮播
    - 显示使用历史
    - _需求: 4.1_

  - [ ]\* 15.3 编写被子组件的单元测试
    - 测试 QuiltCard 渲染
    - 测试 QuiltDetail 渲染
    - _需求: 4.1_

- [x] 16. 实现数据迁移脚本
  - [x] 16.1 创建迁移脚本
    - 创建 scripts/migrate-quilts.ts
    - 读取旧表数据
    - 转换数据格式到新架构
    - 验证数据完整性
    - _需求: 7.1, 7.3_

  - [ ]\* 16.2 编写迁移脚本的属性测试
    - **属性 20: 迁移数据完整性**
    - **验证需求: 7.3**

  - [x] 16.3 执行数据迁移
    - 备份现有数据
    - 运行迁移脚本
    - 验证迁移结果
    - _需求: 7.1_

- [x] 17. 实现 API 向后兼容层
  - [x] 17.1 创建兼容性适配器
    - 创建 app/api/legacy/quilts/route.ts
    - 将旧 API 请求转换为新格式
    - 将新响应转换为旧格式
    - _需求: 7.2_

  - [ ]\* 17.2 编写 API 兼容性的属性测试
    - **属性 19: API 向后兼容性**
    - **验证需求: 7.2**

- [x] 18. 实现被子管理特定功能
  - [x] 18.1 实现天气集成功能
    - 创建 lib/weather.ts
    - 集成天气 API
    - 根据天气推荐被子
    - _需求: 6.2_

  - [x] 18.2 实现被子使用追踪
    - 添加使用记录功能
    - 显示使用统计
    - _需求: 6.2_

  - [ ]\* 18.3 编写被子功能的单元测试
    - 测试天气集成
    - 测试使用追踪
    - _需求: 6.2_

- [x] 19. 检查点 - 确保被子模块完整迁移
  - 确保所有测试通过，如有问题请询问用户

### 阶段 4: 球星卡管理模块

- [x] 20. 创建球星卡模块配置
  - [x] 20.1 定义球星卡模块 Schema
    - 创建 modules/cards/schema.ts
    - 定义 cardAttributesSchema（球员名称、运动类型、年份、品牌、系列、卡号、评级、价值等）
    - 定义 CardAttributes 和 Card 类型
    - _需求: 2.2, 5.2_

  - [x] 20.2 创建球星卡模块配置
    - 创建 modules/cards/config.ts
    - 定义 cardModule 配置对象
    - 配置表单字段
    - 配置列表列
    - 配置统计指标（总价值、平均评级等）
    - _需求: 5.1, 5.2_

  - [x] 20.3 注册球星卡模块
    - 在 modules/registry.ts 中注册 cardModule
    - _需求: 1.1_

- [x] 21. 创建球星卡模块 UI 组件
  - [x] 21.1 实现 CardCard 组件
    - 创建 modules/cards/ui/CardCard.tsx
    - 显示球星卡的关键信息（球员、年份、评级、价值）
    - 显示卡片图片
    - _需求: 4.1_

  - [x] 21.2 实现 CardDetail 组件
    - 创建 modules/cards/ui/CardDetail.tsx
    - 显示球星卡的完整信息
    - 显示价值历史图表
    - 显示收藏统计
    - _需求: 4.1_

  - [ ]\* 21.3 编写球星卡组件的单元测试
    - 测试 CardCard 渲染
    - 测试 CardDetail 渲染
    - _需求: 4.1_

- [x] 22. 实现球星卡特定功能
  - [x] 22.1 实现价值追踪功能
    - 创建价值历史记录表
    - 实现价值更新功能
    - 显示价值趋势图表
    - _需求: 6.2_

  - [x] 22.2 实现评级管理
    - 支持多种评级系统（PSA, BGS, SGC 等）
    - 显示评级详情
    - _需求: 5.2_

  - [ ]\* 22.3 编写球星卡功能的单元测试
    - 测试价值追踪
    - 测试评级管理
    - _需求: 6.2_

- [x] 23. 检查点 - 确保球星卡模块正常工作
  - 确保所有测试通过，如有问题请询问用户

### 阶段 5: 权限和安全

- [ ] 24. 实现基于角色的访问控制（RBAC）
  - [ ] 24.1 创建权限系统
    - 创建 lib/permissions.ts
    - 定义角色和权限映射
    - 实现权限检查函数
    - _需求: 8.1, 8.2_

  - [ ] 24.2 在 Server Actions 中集成权限检查
    - 在所有 CRUD 操作中添加权限验证
    - 实现资源级权限控制
    - _需求: 8.2, 8.3_

  - [ ]\* 24.3 编写权限系统的属性测试
    - **属性 22: 基于角色的访问控制**
    - **验证需求: 8.1, 8.3**

  - [ ]\* 24.4 编写权限粒度控制的属性测试
    - **属性 23: 权限粒度控制**
    - **验证需求: 8.2**

- [ ] 25. 实现多租户数据隔离
  - [ ] 25.1 添加数据隔离逻辑
    - 在所有查询中添加 ownerId 过滤
    - 验证用户只能访问自己的数据
    - _需求: 8.4_

  - [ ]\* 25.2 编写多租户隔离的属性测试
    - **属性 24: 多租户数据隔离**
    - **验证需求: 8.4**

- [-] 26. 实现操作审计日志
  - [ ] 26.1 扩展日志系统
    - 记录所有权限相关操作
    - 记录访问拒绝事件
    - _需求: 8.5_

  - [ ]\* 26.2 编写审计日志的属性测试
    - **属性 25: 权限操作审计**
    - **验证需求: 8.5**

### 阶段 6: 性能优化和缓存

- [x] 27. 实现缓存策略
  - [x] 27.1 配置 Next.js 16 缓存
    - 使用 "use cache" 指令标记可缓存函数
    - 使用 cacheLife() API 配置缓存策略
    - 使用 cacheTag() 标记缓存
    - 使用 updateTag() 进行细粒度缓存更新
    - _需求: 9.2_

  - [x] 27.2 实现数据库查询优化
    - 为常用查询字段创建索引
    - 优化 N+1 查询问题
    - 使用 Drizzle ORM 的查询优化功能
    - _需求: 9.1_

  - [ ]\* 27.3 编写缓存一致性的属性测试
    - **属性 26: 缓存一致性**
    - **验证需求: 9.2**

- [ ] 28. 实现异步任务处理
  - [ ] 28.1 创建任务队列系统
    - 实现后台任务处理
    - 处理耗时操作（数据导出、批量更新等）
    - _需求: 9.4_

  - [ ]\* 28.2 编写异步任务的属性测试
    - **属性 27: 异步任务非阻塞**
    - **验证需求: 9.4**

- [ ] 29. 实现性能监控
  - [ ] 29.1 集成性能监控工具
    - 添加性能指标收集
    - 监控数据库查询性能
    - 监控 API 响应时间
    - _需求: 9.5_

- [x] 30. 检查点 - 确保性能优化生效
  - 确保所有测试通过，如有问题请询问用户

### 阶段 7: 开发者工具和文档

- [ ] 31. 创建 CLI 工具
  - [ ] 31.1 实现模块生成器
    - 创建 scripts/generate-module.ts
    - 生成模块脚手架代码
    - 生成 Schema、配置和 UI 组件模板
    - _需求: 10.2_

  - [ ]\* 31.2 编写 CLI 工具的单元测试
    - 测试模块生成功能
    - 测试生成的代码结构
    - _需求: 10.2_

- [ ] 32. 编写开发者文档
  - [ ] 32.1 创建 API 文档
    - 文档化所有 Server Actions
    - 提供使用示例
    - _需求: 10.1_

  - [ ] 32.2 创建模块开发指南
    - 编写模块开发最佳实践
    - 提供完整的示例模块
    - _需求: 10.5_

  - [ ] 32.3 创建架构文档
    - 文档化系统架构
    - 解释设计决策
    - _需求: 10.1_

- [ ] 33. 设置开发环境工具
  - [ ] 33.1 配置热重载
    - 确保开发环境支持热重载
    - 配置调试工具
    - _需求: 10.3_

  - [-] 33.2 配置测试环境
    - 设置单元测试环境
    - 设置属性测试环境
    - 配置测试覆盖率报告
    - _需求: 10.4_

### 阶段 8: 集成测试和部署

- [ ] 34. 编写集成测试
  - [ ]\* 34.1 编写端到端测试
    - 测试完整的用户流程（注册、登录、创建物品、编辑、删除）
    - 测试多模块切换
    - 测试权限控制
    - _需求: 10.4_

  - [ ]\* 34.2 编写 API 集成测试
    - 测试所有 Server Actions
    - 测试错误处理
    - _需求: 10.4_

- [ ] 35. 配置 CI/CD
  - [ ] 35.1 设置 GitHub Actions
    - 配置自动化测试
    - 配置代码质量检查
    - 配置部署流程
    - _需求: 10.4_

- [ ] 36. 部署到生产环境
  - [ ] 36.1 配置生产环境
    - 设置环境变量
    - 配置数据库连接
    - 配置文件存储
    - _需求: 7.4_

  - [ ] 36.2 执行生产部署
    - 部署到 Vercel
    - 验证部署成功
    - 监控应用性能
    - _需求: 7.4_

- [ ] 37. 最终检查点 - 确保系统完整可用
  - 确保所有测试通过，如有问题请询问用户

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求以确保可追溯性
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边缘情况

## 测试配置

### 属性测试配置

- 使用 fast-check 库进行属性测试
- 每个属性测试最少运行 100 次迭代
- 每个测试必须引用其设计文档属性
- 标签格式: **Feature: extensible-item-management-framework, Property {number}: {property_text}**

### 单元测试配置

- 使用 Vitest + Testing Library
- 专注于特定示例、边缘情况和错误条件
- 与属性测试互补，共同提供全面覆盖

### 测试覆盖率目标

- 核心框架代码: 90%以上
- 模块特定代码: 80%以上
- 关键路径: 100%
